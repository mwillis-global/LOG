<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>M.WILLIS LOG â€“ ARENA</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <style>
    html {
      box-sizing: border-box;
      font-size: 16px;
      height: 100%;
    }
    *, *::before, *::after {
      box-sizing: inherit;
    }
    body {
      font-family: Arial, sans-serif;
      font-size: 1.25rem;
      line-height: 1.2;
      margin: 0;
      background: #000;
    }
    a {
      text-decoration: none;
      color: inherit;
    }
    img {
      max-width: 100%;
      height: auto;
      display: block;
    }
    #arena {
      margin-top: 20px;
    }
    #posts-container {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
    }
    .post {
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    /* Scale presets for posts */
    .scale-1 { width: 20%; }
    .scale-2 { width: 45%; }
    .scale-3 { width: 60%; }
    #fullscreen-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      backdrop-filter: blur(20px);
    }
    #fullscreen-overlay img {
      max-width: 100%;
      max-height: 80%;
    }
  </style>
</head>
<body>
  <div id="arena">
    <div id="posts-container"></div>
    <div id="loading">Loading</div>
  </div>
  <script>
    const settings = {
      channelslug: "log-ja9rinlvzi4"
    };
    const posts = [];
    const loadedPosts = new Set();
    const queryOptions = {
      page: 1,
      direction: "desc",
      sort: "position",
      per: 48
    };
    let loading = false;
    let initialLoad = true;
    const getRandomScaleClass = () => {
      const scaleClasses = ["scale-1", "scale-2", "scale-3"];
      return scaleClasses[Math.floor(Math.random() * scaleClasses.length)];
    };
    const showOverlay = (content) => {
      const overlay = $(`<div id="fullscreen-overlay">${content}</div>`);
      $("body").append(overlay);
    };
    const removeOverlay = () => {
      $("#fullscreen-overlay").remove();
    };
    const fetchPosts = async () => {
      if (loading) return;
      loading = true;
      try {
        if (initialLoad) {
          $("#loading").show();
        }
        const response = await fetch(
          `https://api.are.na/v2/channels/${settings.channelslug}/contents?${$.param(queryOptions)}`
        );
        if (!response.ok) throw new Error(`API error: ${response.statusText}`);
        const data = await response.json();
        const newPosts = data.contents.filter((post) => !loadedPosts.has(post.id));
        newPosts.forEach((post) => loadedPosts.add(post.id));
        if (newPosts.length > 0) {
          addPosts(newPosts);
          queryOptions.page++;
        } else {
          console.log("No new posts to load.");
        }
      } catch (error) {
        console.error("Error fetching posts:", error);
      } finally {
        if (initialLoad) {
          $("#loading").hide();
          initialLoad = false;
        }
        loading = false;
      }
    };
    const addPosts = (newPosts) => {
      const fragment = document.createDocumentFragment();
      newPosts.forEach((post) => {
        let postElement;
        switch (post["class"]) {
          case "Image":
            const scaleClass = getRandomScaleClass();
            postElement = $(`
              <div class="post ${scaleClass}">
                <img src="${post.image.thumb.url}" alt="${post.generated_title || ''}" 
                     data-full="${post.image.display.url}" 
                     data-index="${posts.length}" 
                     data-width="${post.image.original.width}" 
                     data-height="${post.image.original.height}">
              </div>
            `)[0];
            break;
          // Restore additional cases (Text, Media, Link) if needed
        }
        fragment.appendChild(postElement);
        posts.push(post);
      });
      $("#posts-container").append(fragment);
    };
    $(document).on("click", ".post img", function () {
      const img = $(this);
      const fullSrc = img.data("full");
      const currentIndex = parseInt(img.data("index"), 10);
      const content = `<img src="${fullSrc}" style="max-height: 80%;" data-index="${currentIndex}">`;
      showOverlay(content);
    });
    $(document).on("keydown", function (event) {
      const fullscreenOverlay = $("#fullscreen-overlay");
      if (!fullscreenOverlay.length) return;
      if (event.key === "Escape") {
        removeOverlay();
      }
    });
    $(document).on("click", "#fullscreen-overlay", function () {
      removeOverlay();
    });
    $(window).on("scroll", () => {
      if ($(window).scrollTop() + $(window).height() >= $(document).height() - 100) {
        fetchPosts();
      }
    });
    fetchPosts();
  </script>
</body>
</html>
