<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>M.WILLIS LOG â€“ ARENA</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <style>
    html {
      box-sizing: border-box;
      font-size: 16px;
      height: 100%;
    }

    *, *::before, *::after {
      box-sizing: inherit;
    }

    body {
      font-family: Arial, sans-serif;
      font-size: 1.25rem;
      line-height: 1.2;
      margin: 0;
      background: #000;
      color: #fff;
    }

    a {
      text-decoration: none;
      color: inherit;
    }

    img {
      max-width: 100%;
      height: auto;
      display: block;
    }

    #arena {
      margin-top: 20px;
    }

    #posts-container {
      padding: 10px;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      grid-auto-rows: 10px;
      grid-gap: 15px;
    }

    .post {
      margin: 0;
      background: rgba(30, 30, 30, 0.7);
      border-radius: 4px;
      overflow: hidden;
      display: flex;
      justify-content: center;
      align-items: center;
      transition: transform 0.3s ease;
      position: relative;
    }

    .post:hover {
      transform: scale(1.02);
    }

    .post.image-post {
      padding: 0;
    }

    .post-content {
      width: 100%;
      height: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .post img {
      width: auto;
      height: auto;
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
    }

    .post.size-1 {
      grid-row-end: span 20;
    }

    .post.size-2 {
      grid-row-end: span 30;
    }

    .post.size-3 {
      grid-row-end: span 40;
    }

    /* For non-image posts */
    .post.text-post, .post.link-post, .post.media-post {
      padding: 15px;
      grid-row-end: span 20;
    }

    #fullscreen-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      backdrop-filter: blur(20px);
      background-color: rgba(0, 0, 0, 0.7);
    }

    #fullscreen-overlay img {
      max-width: 90%;
      max-height: 90%;
      object-fit: contain;
    }

    #loading {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 1rem;
      color: #ccc;
      display: none;
    }

    #loading::after {
      content: '...';
      display: inline-block;
      animation: dots 1.5s steps(3, end) infinite;
    }

    @keyframes dots {
      0%, 20% { content: ''; }
      40% { content: '.'; }
      60% { content: '..'; }
      80%, 100% { content: '...'; }
    }
  </style>
</head>
<body>
  <div id="arena">
    <div id="posts-container"></div>
    <div id="loading">Loading</div>
  </div>

  <script>
    const settings = {
      channelslug: "log-ja9rinlvzi4"
    };

    const posts = [];
    const loadedPosts = new Set(); // Track loaded post IDs
    const queryOptions = {
      page: 1, // Start from page 1
      direction: "desc",
      sort: "position",
      per: 48
    };

    let loading = false;
    let initialLoad = true; // Flag to check if it's the initial load

    // Utility functions for overlay management
    const showOverlay = (content) => {
      const overlay = $(`
        <div id="fullscreen-overlay">
          ${content}
        </div>
      `);
      $("body").append(overlay);
    };

    const removeOverlay = () => {
      $("#fullscreen-overlay").remove();
    };

    // Function to get random size class
    const getRandomSizeClass = () => {
      const sizes = ['size-1', 'size-2', 'size-3'];
      const randomIndex = Math.floor(Math.random() * sizes.length);
      return sizes[randomIndex];
    };

    // Calculate appropriate size based on image dimensions
    const getSizeFromDimensions = (width, height) => {
      // If dimensions aren't available or we want true randomness
      if (!width || !height) {
        return getRandomSizeClass();
      }
      
      // Calculate aspect ratio
      const ratio = width / height;
      
      // Give taller images more vertical space
      if (ratio < 0.8) return 'size-3';
      // Square-ish images get medium space
      if (ratio >= 0.8 && ratio <= 1.2) return 'size-2';
      // Wide images get less vertical space
      return 'size-1';
    };

    // Fetch posts from Are.na API
    const fetchPosts = async () => {
      if (loading) return; // Prevent multiple calls
      loading = true;

      try {
        // Show loader only on initial page load
        if (initialLoad) {
          $("#loading").show();
        }

        const response = await fetch(
          `https://api.are.na/v2/channels/${settings.channelslug}/contents?${$.param(queryOptions)}`
        );
        if (!response.ok) throw new Error(`API error: ${response.statusText}`);

        const data = await response.json();

        // Filter new posts
        const newPosts = data.contents.filter((post) => !loadedPosts.has(post.id));
        newPosts.forEach((post) => loadedPosts.add(post.id));

        if (newPosts.length > 0) {
          addPosts(newPosts);
          queryOptions.page++; // Increment page only when new posts are added
        } else {
          console.log("No new posts to load.");
        }
      } catch (error) {
        console.error("Error fetching posts:", error);
      } finally {
        // Hide loader after the initial load or after any new data is loaded
        if (initialLoad) {
          $("#loading").hide();
          initialLoad = false; // Only show loader on initial load
        }
        loading = false;
      }
    };

    // Add multiple posts to the DOM
    const addPosts = (newPosts) => {
      const fragment = document.createDocumentFragment();

      newPosts.forEach((post) => {
        let postElement;
        let sizeClass;

        switch (post["class"]) {
          case "Image":
            // Get a size class based on image dimensions when available
            sizeClass = getSizeFromDimensions(
              post.image.original.width, 
              post.image.original.height
            );
            
            postElement = $(`
              <div class="post image-post ${sizeClass}">
                <div class="post-content">
                  <img src="${post.image.thumb.url}" alt="${post.generated_title || ''}" 
                       data-full="${post.image.display.url}" 
                       data-index="${posts.length}" 
                       data-width="${post.image.original.width}" 
                       data-height="${post.image.original.height}">
                </div>
              </div>
            `)[0];
            break;
          case "Text":
            postElement = $(`
              <div class="post text-post ${getRandomSizeClass()}">
                <div class="post-content">${post.content_html || "No content"}</div>
              </div>
            `)[0];
            break;
          case "Media":
            postElement = $(`
              <div class="post media-post ${getRandomSizeClass()}">
                <div class="post-content">
                  <iframe src="${post.embed.url}" width="100%" height="100%" frameborder="0"></iframe>
                </div>
              </div>
            `)[0];
            break;
          case "Link":
            postElement = $(`
              <div class="post link-post ${getRandomSizeClass()}">
                <div class="post-content">
                  <a href="${post.source.url}" target="_blank">${post.generated_title || "Link"}</a>
                </div>
              </div>
            `)[0];
            break;
          default:
            console.warn("Unknown post type:", post);
            return;
        }

        fragment.appendChild(postElement);
        posts.push(post); // Add to posts array
      });

      $("#posts-container").append(fragment);
      
      // Apply dynamic sizing to ensure images fit correctly
      adjustImageSizes();
    };

    // Function to adjust image sizing to prevent cropping
    const adjustImageSizes = () => {
      $('.post.image-post').each(function() {
        const post = $(this);
        const img = post.find('img');
        const postHeight = post.height();
        
        // If image is loaded, check if we need to adjust the post height
        img.on('load', function() {
          const imgHeight = img[0].naturalHeight;
          const imgWidth = img[0].naturalWidth;
          
          // Ensure the post is tall enough for the image
          if (imgHeight > 0 && imgWidth > 0) {
            const imgRatio = imgWidth / imgHeight;
            const postWidth = post.width();
            const neededHeight = postWidth / imgRatio;
            
            // If the needed height is greater than current post height, adjust size class
            if (neededHeight > postHeight) {
              // Find the appropriate size class
              post.removeClass('size-1 size-2 size-3');
              if (neededHeight > 300) {
                post.addClass('size-3');
              } else if (neededHeight > 200) {
                post.addClass('size-2');
              } else {
                post.addClass('size-1');
              }
            }
          }
        });
      });
    };

    // Fullscreen and navigation functionality
    $(document).on("click", ".post img", function () {
      const img = $(this);
      const fullSrc = img.data("full");
      const currentIndex = parseInt(img.data("index"), 10);

      const content = `<img src="${fullSrc}" style="max-height: 90%;" data-index="${currentIndex}">`;
      showOverlay(content);
    });

    $(document).on("keydown", function (event) {
      const fullscreenOverlay = $("#fullscreen-overlay");
      if (!fullscreenOverlay.length) return;

      const fullscreenImg = fullscreenOverlay.find("img");
      const currentIndex = parseInt(fullscreenImg.data("index"), 10);

      if (event.key === "ArrowRight") {
        const nextIndex = (currentIndex + 1) % posts.length;
        const nextPost = posts[nextIndex];
        if (nextPost.class === "Image") {
          fullscreenImg.attr("src", nextPost.image.display.url)
                      .data("index", nextIndex);
        }
      } else if (event.key === "ArrowLeft") {
        const prevIndex = (currentIndex - 1 + posts.length) % posts.length;
        const prevPost = posts[prevIndex];
        if (prevPost.class === "Image") {
          fullscreenImg.attr("src", prevPost.image.display.url)
                      .data("index", prevIndex);
        }
      } else if (event.key === "Escape") {
        removeOverlay();
      }
    });

    // Close fullscreen on overlay click
    $(document).on("click", "#fullscreen-overlay", function () {
      removeOverlay();
    });

    // Recalculate image sizes on window resize
    $(window).on("resize", function() {
      adjustImageSizes();
    });

    // Infinite scroll
    $(window).on("scroll", () => {
      if ($(window).scrollTop() + $(window).height() >= $(document).height() - 200) {
        fetchPosts();
      }
    });

    // Initial fetch
    fetchPosts();
  </script>
</body>
</html>
